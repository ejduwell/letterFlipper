# letterFlipper

Repository of code which establishes a generalized framework for building and running visual stimuli presenting letters in MATLAB with Psychtoolbox.

## General Overview:

**letterFlipper** is a MATLAB repository developed for building and implimenting cognitive vision science experiments presenting letter stimuli with Psychtoolbox. **letterFlipper** contains generalized code enabling users to quickly and flexibly design and run wide range of potential visual tasks presenting letters/characters.

### Brief Description of Features/Capabilities:

- Separate functions and workflows for image/task creation and task presentation enable users to develop and impliment tasks in a modular manner:
    - **letterFlipper** has separate, 'stand-alone' functions/workflows for both generating the stack of images and files presented in an experiment and for presenting them in the precise manner desired.
    - In other words, **letterFlipper** allows users to flexibly pre-generate a set of task images/rules with a "letter image/task generation" workflow and impliment/present them in desired manner using a separate "letter image flipper" task presentation workflow.
      
- Frameworks for creating and running tasks are highly generalized and are capable of both generating and implimenting a wide range of potential different tasks with minimal coding.
    - **Q:** *How does **letterFlipper** achieve this?* **A:** *Parameter Descriptor Files!*
      - Users can flexibly create and update 'parameter descriptor files' (see [Usage](https://github.com/ejduwell/letterFlipper/tree/main?tab=readme-ov-file#short-list-of-important-files-and-foldersdirectories) for details)
      - These allow users to define/specify all relevant aspects of task.
      - The "image flipper" for presenting stimuli and collecting data is highly generalized and can run any task generated by the "letter image/task generation workflow" without any updating or re-coding.
      - Consequently, [users can create, develop, and run a wide range of letter-based visual stimuli with **letterFlipper** by simply specifying new sets of parameters in different parameter descriptor files.](https://github.com/ejduwell/letterFlipper/tree/main?tab=readme-ov-file#general-workflow-for-creating-and-running-stimuli-with-letterflipper)
        
- Task image parameter maniplations currently supported by letterFlipper out-of-the-box allow users to specify:
  - the set of letters presented
      - a 'Snellen E Mode" allows users to generate and present 'Snellen-like' letter 'E' stimuli similar to those used in clinical ophthalmology exams
  - the number of letters presented per task image.
  - the set of different locations in which letters can appear
  - the set of possible text sizes
  - the set of possible text colors/luminance values in the form of rgb vectors
  - the set of possible rotation angles applied to letters
  - specify which of these parameters is the "response parameter" to which subjects will be responding via pressing butons thoughout the task
  - specify the corresponding set of expected button presses for each possible response parameter value
  - specify which parameter will be manipulated by QUEST to control task difficulty

- Task presentation/implimentation parameter maniplations currently supported by letterFlipper out-of-the-box allow users to specify:
    - the # of trials per run
    - the number of runs per block
    - low-level trial architecture / timing parameters such as:
      - image presentation onset and disappearance times
      - response window length
      - interstimulus interval time between trials
    - QUEST-related parameters controling how the QUEST staircase procedure will function during the task including:
      - total # of interleaved QUEST procedures to run (Can handle any desired # of interleaved QUESTS from 1 to N)
      - the desired accuracy threshold for each QUEST to 'home in on'
      - QUEST starting parameter values

## Dependencies:

- MATLAB R2021a or newer
- Required Toolbox(es):
  - MATLAB (base)
  - [Deep Learning Toolbox](https://www.mathworks.com/help/deeplearning/index.html?s_tid=srchtitle_site_search_1_Deep+learning+toolbox)
  - [Computer Vision Toolbox](https://www.mathworks.com/help/vision/index.html?s_tid=srchtitle_site_search_1_Computer+vision+toolbox)
  - [Psychtoolbox 3](http://psychtoolbox.org/) (I developed this repository using version [3.0.19.13](https://github.com/Psychtoolbox-3/Psychtoolbox-3/tree/3.0.19.13))

## Installation:

### macOS and Linux

Open a terminal and run:

```bash
# Navigate to desired install location
cd ~/Documents/MATLAB
```

```bash
# Clone the repository from GitHub
git clone https://github.com/ejduwell/letterFlipper.git
```

```bash
# Open MATLAB and add the project to your path:
addpath(genpath('~/Documents/MATLAB/letterFlipper'))
savepath
```

### Windows

1. Open MATLAB
2. In the Command Window, run:

```matlab
% Change directory to desired location
cd('C:\Users\YourName\Documents\MATLAB')
```

```matlab
% Clone from GitHub (or download ZIP and unzip manually)
system('git clone https://github.com/ejduwell/letterFlipper.git')
```

```matlab
% Add the project folder to your MATLAB path:
addpath(genpath('C:\Users\YourName\Documents\MATLAB\letterFlipper'))
savepath
```

## Usage:

### Short List of Important Files and Folders/Directories:

| File/Folder                         | Description                                                                                                             |
|-------------------------------------|-------------------------------------------------------------------------------------------------------------------------|
| `letterFlipper/`                    | Main program directory. Contains Matlab code.                                                                           |
| `letterFlipper/stimImages/`         | Subdirectory where stimulus images are saved/stored.                                                                    |
| `letterFlipper/expDataOut/`         | Subdirectory where subjects' data are saved                                                                             |
| `txtPltCntrlFixImgStackBldr_v1.m`   | Main function for generating stimulus image sets                                                                        |
| `txtTaskImgBuilderPDF_01.m`         | 'Parameter Descriptor File' instance/template for defining adustable parameters used in txtPltCntrlFixImgStackBldr_v1.m |
| `genImgFlipperMain_v1.m`            | Main function for running/presenting stimuli                                                                            |
| `genImgFlipperPDF_01.m`             | 'Parameter Descriptor File' instance/template for defining adustable parameters used in genImgFlipperMain_v1.m          |


### General workflow for creating and running stimuli with letterFlipper:

As described above, **letterFlipper** is capbable of generating and running a wide range of potential stimulus designs.

However, regardless of the details of any particular use case, the creation of tasks with letterFlipper should always follow the following general workflow:

---
> - **Step 00:** Make a new `txtTaskImgBuilderPDF_##.m` instance/copy for this task, and adjust parameters to set desired stimulus image and response parameters
> - **Step 01:** Update a single parameter in `txtPltCntrlFixImgStackBldr_v1.m` to point to your new `txtTaskImgBuilderPDF_##.m` file, then run it to generate the desired stimulus image files.
> - **Step 02:** Make a new `genImgFlipperPDF_##.m` instance/copy for this task pointing to stimulus files created in **Step 01** and adjust other stimulus presentation parameters as desired.
> - **Step 03:** Update a single parameter in `genImgFlipperMain_v1.m` to point to your newly created `genImgFlipperPDF_##.m` instance.
> - **Step 04:** Run `genImgFlipperMain_v1.m` to run the task.
---

### Detailed Instructions for letterFlipper Workflow:

Below are more detailed instructions to walk you through each of the 5 steps in the section above.

---
> **Step 00:** Make a new `txtTaskImgBuilderPDF_##.m` instance/copy for this task, and adjust parameters to set desired stimulus image and response parameters
---
> *Step 00a:* make a copy of the `txtTaskImgBuilderPDF_01.m` template in the main `letterFlipper/` folder and give it a unique name. For the purposes of this instruction demo lets call it `txtTaskImgBuilderPDF_yourName.m`

> *Step 00b:* Edit/update the parameters in each section of `txtTaskImgBuilderPDF_yourName.m` to specify the content of the task letter image set, expected button presses, and all other parameters accepted by `txtPltCntrlFixImgStackBldr_v1.m` , the 'main function' for the 'image/task generation' workflow:

> #### Under the section titled *Specify Parameters that vary across images*:
```matlab
% Build out set of letters
%--------------------------------------------------------------------------
parStruct.letterSet={'E'};% specify letters you wish to include (1xN cell)
parStruct.SnellenEmode=1; % if 1, will build "snellen Es" instead of drawing normal text..
%--------------------------------------------------------------------------
```

```matlab
% Build out set of locations
%--------------------------------------------------------------------------
parStruct.nEcc=1; % specify number of eccentricity values
parStruct.MinMaxEcc=[0,0]; % set max/min eccentricity
parStruct.nAng=1; % specify number of angle values 
parStruct.MinMaxAng=[0,0]; % for nAng evenly spaced between 0 and 360
% (line below automatically generates the set of coordinates with the pars 
% specified above using genEccAngSet_v1)
parStruct.LocationSet = genEccAngSet_v1(parStruct.nEcc, parStruct.nAng, parStruct.MinMaxEcc, parStruct.MinMaxAng);
%--------------------------------------------------------------------------
```

```matlab
% Build out set of text sizes
%--------------------------------------------------------------------------
parStruct.nTxtSizes=71; % set desired number of different text sizes
parStruct.txtSizeMinMax=[5,75]; % set min and max text size
% (line below automatically generates the set of text sizes with the pars 
% specified above using linspace)
parStruct.txtSizeSet=num2cell(linspace(parStruct.txtSizeMinMax(1),parStruct.txtSizeMinMax(2),parStruct.nTxtSizes));
%--------------------------------------------------------------------------
```

```matlab
% Build out set of text colors
%--------------------------------------------------------------------------
% specify set of rgb vectors to set the possible text color/luminance vals
parStruct.txtClrSet={
    [0,0,0],... % (one rgb vector per line)
    };
%--------------------------------------------------------------------------
```

```matlab
% Build out set of text rotation angles
%--------------------------------------------------------------------------
% note, angles assume clockwise rotation..
parStruct.txtAngSet={
    0,...
    90,...
    -90,...
    180,...
    };
%--------------------------------------------------------------------------
```

> ***Note:** the following 3 should be updated together such that the parameter names, sets, and header names correspond to the same stimulus aspect.*

```matlab
% List Names for Sets Pars Changing Across Images
%--------------------------------------------------------------------------
parStruct.combVecParNames={
    "setOfLetters",...
    "setOfLocations",...
    "txtSize",...
    "txtClr",...
    "setOfAngles",...
    };
%--------------------------------------------------------------------------

% List Corresponding Sets of Pars Changing Across Images
%--------------------------------------------------------------------------
parStruct.combVecPars={
    parStruct.letterSet,...
    parStruct.LocationSet,...
    parStruct.txtSizeSet,...
    parStruct.txtClrSet,...
    parStruct.txtAngSet,...
    };
%--------------------------------------------------------------------------

% List TDF Header Label Names for Sets Pars Changing Across Images
%--------------------------------------------------------------------------
parStruct.tdfHeaderz={
    "Letter",...
    "Location",...
    "TextSize",...
    "TextColor",...    
    "TextRotation",...
    };
%--------------------------------------------------------------------------
```
    
> #### Under the section titled *Generate full set of all possible images with combVecCellz2Struct_v1*:
> - You shouldn't need to change anything here.
> - The one command run in this section (combVecCellz2Struct_v2) takes the parameter sets defined in the previous section and generates the full set of possible combinations efficiently using the combvec function.

    
>  #### Under the section titled *Specify parameter for responses*:

```matlab
parStruct.respParName=parStruct.combVecParNames{1,5}; % specify par name in combVecParNames
parStruct.respColName=parStruct.tdfHeaderz{1,5}; % specify column name in tdfHeaderz
% Automatically save the index too..
parStruct.respParIdx = find(cellfun(@(x) isequal(x, parStruct.respParName), parStruct.combVecParNames));
```
    
>  #### Under the section titled *Specify parameter for QUEST to manipulate*:

```matlab
parStruct.qstParName=parStruct.combVecParNames{1,3}; % specify par name in combVecParNames
parStruct.qstColName=parStruct.tdfHeaderz{1,3}; % specify column name in tdfHeaderz
% Automatically save the index too..
parStruct.qstParIdx = find(cellfun(@(x) isequal(x, parStruct.qstParName), parStruct.combVecParNames));
```
    
>  #### Under the section titled *Specify Buttons and Build Correct Button Column*:

```matlab
parStruct.buttons=upper({'W','D','A','S'}); % set buttons. ensure uppercase..

% Build out parKeyPressDecoder:
% each row is for a single parameter and should contain a 1x2 cell array.
% the first variable in each cell array should be the parameter value, the
% second variable in each cell array should be the expected character
% string for desired "correct" button press for that par value
%--------------------------------------------------------------------------
parStruct.parKeyPressDecoder={
    {parStruct.combVecPars{1,parStruct.respParIdx}{1,1},parStruct.buttons{1,1}}, ...
    {parStruct.combVecPars{1,parStruct.respParIdx}{1,2},parStruct.buttons{1,2}}, ...
    {parStruct.combVecPars{1,parStruct.respParIdx}{1,3},parStruct.buttons{1,3}}, ...
    {parStruct.combVecPars{1,parStruct.respParIdx}{1,4},parStruct.buttons{1,4}}, ...
    };
%--------------------------------------------------------------------------

% Build out the "correct button press" array automatically using Ethan's
% respPar2KeyPress_v1 function, the response parameter in the first input
% position, and the parKeyPressDecoder in the second positon.
%--------------------------------------------------------------------------
parStruct.correctButtons = respPar2KeyPress_v1(parStruct.updatedImgPars.(parStruct.respParName),parStruct.parKeyPressDecoder);
%--------------------------------------------------------------------------
```

>  #### Under the section titled *Fixation point parameters...*:

```matlab
%--------------------------------------------------------------------------
parStruct.fixChar='+'; % specify which character to use for fixation
parStruct.fixSize=30; % fixation character size
parStruct.fixClr=[1,1,1]; % fixation character color
%--------------------------------------------------------------------------

```
    
>  #### Under the section titled *Set output stimulus image size..*:

```matlab
%--------------------------------------------------------------------------
parStruct.cropsz = 1024; % output edge dimension of screen & images (square)
%--------------------------------------------------------------------------
```

---
> **Step 01:** Update a single parameter in `txtPltCntrlFixImgStackBldr_v1.m` to point to your new `txtTaskImgBuilderPDF_yourName.m` file, then run it to generate the desired stimulus image files.
---
> *Step 01a:* Open `txtPltCntrlFixImgStackBldr_v1.m` in you matlab editor and scroll to the 'Set Parameters' section

> *Step 01b:* Update the line defining the 'parDescFile' to set this variable equal to your new `txtTaskImgBuilderPDF_yourName.m` filename:

```matlab
% Specify which parameter descriptor file name to use..
parDescFile="txtTaskImgBuilderPDF_yourName";
```
> *Step 01c:* Run txtPltCntrlFixImgStackBldr_v1 either by hitting the green "Run" button in the editor window or by running it as a command in the Matlab command window:
```matlab
txtPltCntrlFixImgStackBldr_v1
```

---
> **Step 02:** Make a new `genImgFlipperPDF_##.m` instance/copy for this task pointing to stimulus files created in **Step 01** and adjust other stimulus presentation parameters as desired.
---
> *Step 02a:* Make a copy of the `genImgFlipperPDF_01.m` template in the main `letterFlipper/` folder and give it a unique name. For the purposes of this instruction demo lets call it `genImgFlipperPDF_yourName.m`

> *Step 02b:* Open `genImgFlipperPDF_yourName.m` in you matlab editor, scroll to the 'Input Data/TDF Parameters' section. Update the line defining 'expParz.path2tdfMat' to set this variable equal to the 

---
> **Step 03:** Update a single parameter in `genImgFlipperMain_v1.m` to point to your newly created `genImgFlipperPDF_##.m` instance.
---

---
> **Step 04:** Run `genImgFlipperMain_v1.m` to run the task.
---




## Task Data Output:






